import pytest

import numpy as np
from openff.units import unit

from modelforge.curate import Record, SourceDataset
from modelforge.curate.units import GlobalUnitSystem
from modelforge.curate.properties import *

from modelforge.curate.datasets.curation_baseclass import DatasetCuration


def test_dipole_moment_calculation():
    class TestCuration(DatasetCuration):
        def _init_dataset_parameters(self):
            pass

    # testing on  007 ARG from spice2
    positions = Positions(
        value=np.array(
            [
                [
                    [0.41130853, -0.29579133, 0.05571501],
                    [0.70705056, 0.1196055, 0.06803529],
                    [0.4835338, -0.28912774, 0.15450846],
                    [0.6589673, 0.04629339, 0.15341634],
                    [0.09838394, 0.05620532, -0.12645122],
                    [-0.6303358, -0.31090915, -0.24944457],
                    [-0.4936998, -0.28256306, -0.24720705],
                    [-0.7212378, -0.21769346, -0.19913486],
                    [-0.44830486, -0.16090095, -0.1952675],
                    [-0.6755626, -0.09615002, -0.1471275],
                    [-0.5383345, -0.06459142, -0.14544845],
                    [0.1576179, 0.09251871, -0.23684597],
                    [0.69779694, 0.04807342, 0.2815741],
                    [0.14056315, 0.09597486, -0.0076066],
                    [-0.39908218, -0.06192343, 0.10733142],
                    [0.54727954, -0.17750567, 0.19178301],
                    [-0.00580153, -0.02132819, -0.13689402],
                    [0.50251305, -0.40993088, 0.24313287],
                    [0.802118, 0.13514376, 0.33638433],
                    [0.25189212, 0.1890528, 0.02089245],
                    [-0.48022667, 0.05438873, 0.06795251],
                    [-0.35274172, 0.26828426, -0.12936133],
                    [-0.49821386, 0.31230676, -0.11585703],
                    [-0.35592726, 0.11659911, -0.14608204],
                    [-0.58235157, 0.18511184, -0.12243588],
                    [0.3902137, 0.1224643, 0.01401945],
                    [-0.48925862, 0.06798078, -0.08603149],
                    [0.4101538, 0.01609841, 0.12334888],
                    [0.548297, -0.05216893, 0.1131132],
                    [-0.66591036, -0.40535703, -0.2896782],
                    [-0.4229554, -0.35540357, -0.2856994],
                    [-0.8275982, -0.2398047, -0.20007816],
                    [-0.34162116, -0.14243487, -0.19347116],
                    [-0.74874175, -0.02638481, -0.10771039],
                    [0.23932706, 0.1505536, -0.23084542],
                    [0.12480536, 0.06012018, -0.32588354],
                    [0.6483111, -0.01114349, 0.3459606],
                    [0.09013392, 0.06082617, 0.07210302],
                    [-0.43313748, -0.14495769, 0.05812184],
                    [-0.4042339, -0.07634643, 0.20824675],
                    [0.607546, -0.18532366, 0.27214822],
                    [-0.03684331, -0.05222198, -0.22709979],
                    [-0.05634984, -0.0501423, -0.05471128],
                    [0.44185555, -0.49193463, 0.20481461],
                    [0.60735893, -0.43929234, 0.24247025],
                    [0.47099647, -0.38605097, 0.34453267],
                    [0.7674253, 0.18162435, 0.4288271],
                    [0.8920841, 0.07704247, 0.35746026],
                    [0.8278184, 0.21416262, 0.2653536],
                    [0.23842983, 0.23181428, 0.1204975],
                    [0.24940616, 0.27178112, -0.05025344],
                    [-0.43801162, 0.1454013, 0.11184394],
                    [-0.5812581, 0.04236865, 0.10867327],
                    [-0.3043195, 0.31623146, -0.21505453],
                    [-0.29726067, 0.2952155, -0.03888037],
                    [-0.5265889, 0.38169438, -0.19565056],
                    [-0.51310253, 0.36256832, -0.01972566],
                    [-0.26984298, 0.0696943, -0.09778006],
                    [-0.35253912, 0.09308639, -0.2530187],
                    [-0.6196562, 0.17241816, -0.22468816],
                    [-0.6688282, 0.19180627, -0.05559914],
                    [0.4040311, 0.07671524, -0.08406249],
                    [0.46496728, 0.20086823, 0.02602954],
                    [0.39932564, 0.06216513, 0.22173649],
                    [0.33160236, -0.05863262, 0.11246528],
                    [0.5667641, -0.0782447, 0.00859369],
                ]
            ]
        ),
        units=unit.nanometer,
    )

    charges = PartialCharges(
        value=np.array(
            [
                [
                    [-0.63724726],
                    [-0.59185505],
                    [0.8215345],
                    [0.6737049],
                    [1.0231042],
                    [-0.13568029],
                    [-0.1261484],
                    [-0.11253503],
                    [-0.21952946],
                    [-0.19249053],
                    [0.06502347],
                    [-0.9252221],
                    [-0.56190723],
                    [-0.6400435],
                    [-0.96135616],
                    [-0.63288206],
                    [-0.95366013],
                    [-0.6824144],
                    [-0.17004295],
                    [0.00631138],
                    [0.0766362],
                    [-0.21106213],
                    [-0.19152217],
                    [-0.2250725],
                    [-0.2490422],
                    [-0.31882274],
                    [0.01574999],
                    [-0.25544018],
                    [-0.01889882],
                    [0.14373958],
                    [0.13563025],
                    [0.14401634],
                    [0.12618725],
                    [0.15054023],
                    [0.4461465],
                    [0.44775078],
                    [0.34217808],
                    [0.39638954],
                    [0.3908998],
                    [0.37163648],
                    [0.35155675],
                    [0.44855404],
                    [0.44908404],
                    [0.21671738],
                    [0.19125023],
                    [0.18140866],
                    [0.11754125],
                    [0.12133403],
                    [0.15507519],
                    [0.13962482],
                    [0.10906038],
                    [0.09654428],
                    [0.06360894],
                    [0.10333423],
                    [0.0907615],
                    [0.11341174],
                    [0.10244449],
                    [0.09175525],
                    [0.11169444],
                    [0.13099036],
                    [0.11420555],
                    [0.13457368],
                    [0.17605565],
                    [0.11712421],
                    [0.15005884],
                    [0.15786003],
                ]
            ]
        ),
        units=unit.elementary_charge,
    )

    atomic_numbers = AtomicNumbers(
        value=np.array(
            [
                [8],
                [8],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [7],
                [7],
                [7],
                [7],
                [7],
                [7],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [6],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
                [1],
            ]
        )
    )

    scf_dipole_moment = DipoleMomentPerSystem(
        value=np.array([[0.11519327, 0.04117512, 0.0367095]]),
        units=unit.elementary_charge * unit.nanometer,
    )
    scf_dipole_magnitude = DipoleMomentScalarPerSystem(
        value=np.linalg.norm(scf_dipole_moment.value).reshape(1, 1),
        units=unit.elementary_charge * unit.nanometer,
    )
    dataset_curation = TestCuration(hdf5_file_name="test.hdf5")

    dipole_moment_comp = dataset_curation.compute_dipole_moment(
        atomic_numbers=atomic_numbers, positions=positions, partial_charges=charges
    )
    dipole_moment_scaled_comp = dataset_curation.compute_dipole_moment(
        atomic_numbers=atomic_numbers,
        positions=positions,
        partial_charges=charges,
        dipole_moment_scalar=scf_dipole_magnitude,
    )

    # scf dipole: [[0.11519327, 0.04117512, 0.0367095]]
    # computed from partial charges: [[0.11143426, 0.04153308, 0.05102292]]
    # reasonably close
    assert np.allclose(
        scf_dipole_moment.value, dipole_moment_comp.value, atol=1e-1, rtol=1e-3
    )

    assert np.allclose(
        dipole_moment_comp.value, np.array([[0.11143426, 0.04153308, 0.05102292]])
    )

    assert np.allclose(
        np.linalg.norm(dipole_moment_scaled_comp.value).reshape(1, 1),
        scf_dipole_magnitude.value,
    )
